<!DOCTYPE html>
<html>
<head>
    <title>Cache Storage Server</title>
</head>
<body>
    <script>
        async function requestStorageAccess() {
            if (document.hasStorageAccess) {
                const hasAccess = await document.hasStorageAccess();
                if (!hasAccess) {
                    try {
                        await document.requestStorageAccess();
                        console.log("‚úÖ Storage access granted!");
                    } catch (error) {
                        console.warn("üö´ Storage access denied:", error);
                    }
                } else {
                    console.log("‚úÖ IndexedDB access confirmed.");
                }
            }
        }

        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open("CrossDomainCacheDB", 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains("cacheStore")) {
                        db.createObjectStore("cacheStore", { keyPath: "key" });
                    }
                };
                request.onsuccess = (event) => {
                    console.log("‚úÖ IndexedDB opened");
                    resolve(event.target.result);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function setIndexedDB(key, value) {
            const db = await openDB();
            const transaction = db.transaction("cacheStore", "readwrite");
            const store = transaction.objectStore("cacheStore");
            store.put({ key, value });
            console.log(`‚úÖ Saved in IndexedDB: ${key} = ${value}`);
        }

        async function getIndexedDB(key) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction("cacheStore", "readonly");
                const store = transaction.objectStore("cacheStore");
                const request = store.get(key);
                request.onsuccess = () => {
                    console.log(`üì¶ Retrieved from IndexedDB: ${key} = ${request.result?.value}`);
                    resolve(request.result ? request.result.value : null);
                };
                request.onerror = () => reject(request.error);
            });
        }

        window.addEventListener("message", async (event) => {
            if (!event.origin.endsWith(".vercel.app")) {
                console.warn("‚ùå Rejected message from unknown origin:", event.origin);
                return;
            }

            console.log("üì© Received message:", event.data);
            const { action, key, value } = event.data;

            if (action === "set") {
                await requestStorageAccess();
                await setIndexedDB(key, value);
                event.source.postMessage({ key, value: "Saved" }, event.origin);
            } else if (action === "get") {
                await requestStorageAccess();
                const storedValue = await getIndexedDB(key);
                event.source.postMessage({ key, value: storedValue }, event.origin);
            }
        });

        console.log("‚úÖ Iframe storage server is ready!");
    </script>
</body>
</html>
